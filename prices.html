<!DOCTYPE html>
<html>
<body>

<p>Cloud instance prices</p>

<link href="css/tabulator.min.css" rel="stylesheet">
<script type="text/javascript" src="js/tabulator.min.js"></script>
<div id="prices-table"></div>

<script>
  //custom max min header filter
  var minMaxFilterEditor = function(cell, onRendered, success, cancel, editorParams){

      var end;

      var container = document.createElement("span");

      //create and style inputs
      var start = document.createElement("input");
      start.setAttribute("type", "number");
      start.setAttribute("placeholder", "Min");
      start.setAttribute("min", 0);
      start.setAttribute("max", 100);
      start.style.padding = "4px";
      start.style.width = "50%";
      start.style.boxSizing = "border-box";

      start.value = cell.getValue();

      function buildValues(){
          success({
              start:start.value,
              end:end.value,
          });
      }

      function keypress(e){
          if(e.keyCode == 13){
              buildValues();
          }

          if(e.keyCode == 27){
              cancel();
          }
      }

      end = start.cloneNode();

      start.addEventListener("change", buildValues);
      start.addEventListener("blur", buildValues);
      start.addEventListener("keydown", keypress);

      end.addEventListener("change", buildValues);
      end.addEventListener("blur", buildValues);
      end.addEventListener("keydown", keypress);


      container.appendChild(start);
      container.appendChild(end);

      return container;
   }

  //custom max min filter function
  function minMaxFilterFunction(headerValue, rowValue, rowData, filterParams){
      //headerValue - the value of the header filter element
      //rowValue - the value of the column in this row
      //rowData - the data for the row being filtered
      //filterParams - params object passed to the headerFilterFuncParams property

          if(rowValue){
              if(headerValue.start != ""){
                  if(headerValue.end != ""){
                      return rowValue >= headerValue.start && rowValue <= headerValue.end;
                  }else{
                      return rowValue >= headerValue.start;
                  }
              }else{
                  if(headerValue.end != ""){
                      return rowValue <= headerValue.end;
                  }
              }
          }

      return false; //must return a boolean, true if it passes the filter.
  }

  function paramBuilder(column){
    var list = {"":""};
    var data = this.getData().map(a => a[column]);

    data.forEach(function(item){
  	    if(typeof item !== "undefined"){
  		       list[item] = item;
  	    }
    });
    return list;
  }

  function partial(func /*, 0..n args */) {
    var args = Array.prototype.slice.call(arguments, 1);
    return function() {
      var allArguments = args.concat(Array.prototype.slice.call(arguments));
      return func.apply(this, allArguments);
    };
  }

  //Build Tabulator
  var table = new Tabulator("#prices-table", {
      height:"600px",
      layout:"fitDataFill",
      placeholder:"No Data Set",
      dataLoaded:function() {
        var reload_cols = ["provider", "cpu_arch", "region", "spot-az",
                           "spot", "location", "instanceFamily",
                           "currentGeneration", "physicalProcessor"];
        for (var i = 0; i < reload_cols.length; i++) {
            this.getColumn(reload_cols[i]).reloadHeaderFilter();
        }
      },

      columns:[
          {title:"Provider", field:"provider", headerFilter:"select", headerFilterParams:partial(paramBuilder, 'provider')},
          {title:"Instance", field:"instanceType", sorter:"string", headerFilter:"input"},
          {title:"vCPUs", field:"vcpu", sorter:"number", headerFilter:minMaxFilterEditor, headerFilterFunc:minMaxFilterFunction},
          {title:"RAM[GiB]", field:"memory", sorter:"number", headerFilter:minMaxFilterEditor, headerFilterFunc:minMaxFilterFunction},
          {title:"price", field:"price", sorter:"number", headerFilter:minMaxFilterEditor, headerFilterFunc:minMaxFilterFunction},
          {title:"Arch", field:"cpu_arch", headerFilter:"select", headerFilterParams:partial(paramBuilder, 'cpu_arch')},
          {title:"Freq", field:"clockSpeed", sorter:"string"},
          {title:"Region", field:"region", headerFilter:"select", headerFilterParams:partial(paramBuilder, 'region')},
          {title:"Spot AZ", field:"spot-az", headerFilter:"select", headerFilterParams:partial(paramBuilder, 'spot-az')},
          {title:"Spot", field:"spot", headerFilter:"select", headerFilterParams:partial(paramBuilder, 'spot')},
          {title:"Location", field:"location", headerFilter:"select", headerFilterParams:partial(paramBuilder, 'location')},
          {title:"Family", field:"instanceFamily", headerFilter:"select", headerFilterParams:partial(paramBuilder, 'instanceFamily')},
          {title:"Current gen", field:"currentGeneration", headerFilter:"select", headerFilterParams:partial(paramBuilder, 'currentGeneration')},
          {title:"Processor", field:"physicalProcessor", headerFilter:"select", headerFilterParams:partial(paramBuilder, 'physicalProcessor')},
      ],
  });

  table.setData("https://cloudperf-data.s3-us-west-2.amazonaws.com/prices.json");
</script>
</body>
</html>
